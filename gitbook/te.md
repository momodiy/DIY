### 一、项目背景

2018年年底的一个下午，西安的雾霾还是有一些严重，电脑前正在写bug的我突然被叫去一下办公室，还沉浸在编码世界的我没想太多随手拿起笔记本和笔就过去了。来到会议室一共三个人，我、leader和一位后端大佬，原来是接到一个新需求，需要使用全新的技术栈来实现一个物联网管理系统，包含硬件信息采集、GIS地图支持等功能，听到这第一反应：终于有新项目了，还有新技术栈求之不得啊。

这里得介绍一下背景了，之前公司的技术栈是SpringMVC+jquery+bootstrap，技术上难度不高（但是业务确实要学习的有很多），当时也想在之前的项目大展身手，比如给一个前后端不分离的老项目前端模块，配置了node环境，当然仅用于eslint格式化检查修复。

言归正传，确定了要干，接下来一两天就是确定技术方案。因为第一版只考虑实现web端，在Vue和react中选择了vue，主要原因是vue相对好上手，之后其他同事参与进来学习成本也相对低一些；GIS地图选择了当时地图界的老大哥百度地图，
后端技术栈似乎没有争议，妥妥的SpringBoot；
消息推送 websocket

还没开始开发，有道云笔记的文档已经整理了好几篇了，什么框架选型对比、GIS相关开源库支持情况以及业务相关的todo list（story list）。


项目第一阶段大概历时一个月，

### 二、难点痛点
- GIS 地理围栏
- GIS 轨迹动画绘制
- 免费的sdk需要优化请求次数

当时要实现的第一个模块就设计GIS地图，简单的说就是要在百度地图上左侧开发一个用户/设备列表，第一步在地图上显示出设备位置，可以查看电量，

#### 1.穿越地理围栏播报
简单的说就是前端通过鼠标点击地图的不同区域，要在地图上绘制出一个多边形围栏（比如点击四下你可以绘制一个四边形围栏），当用户携带硬件（手表或其他硬件设备）穿越围栏，系统会自动推送一条数据，前端如果开启了websocket订阅就能接收到一条推送消息，接下来前端要根据推送内容调用百度的语音播报SDK将文字转化为临时语音文件，播放出来。

大概列一下这个需求索要包含的技术点

- 通过坐标拾取绘制围栏区域以及围栏的增删改查
- 实时定位监测（判断是否穿越围栏）
- websocket发布订阅监听预警信息
- 百度云sdk实现离线语音合成（FIFO消息管理）

以上技术点挑两个重点来说吧，首先是坐标拾取，点击时获取点击位置的经纬度坐标，点击多个点时在地图上绘制出多边形，这个操作使用了当时 GitHub 上 star 最多的开源库 [bue-baidu-map](https://github.com/Dafrok/vue-baidu-map) ，（源码注释中发现这个开源库的作者也是百度的大佬）项目里面有大量的demo可供使用，包括我需要的位置点采集、多边形围栏绘制等功能，可惜支持的围栏只是简单地渲染出来，没发从一个点开始够了创建，当时借鉴了这个开源库的部分代码改造实现了该功能，成就满满。

再说下websocket，也因为也是第一次使用，刚接收到接口推送的消息感觉很开心，又入门了一项技能，在之后经过不断打磨，解决了组件切换导致重复订阅、连接不稳定、心跳监测重连等等问题后，终于能够稳定的监听硬件推送消息了~


#### 2.轨迹动画绘制
因为地图上动画的实现已经在开源库中找到了解决方案，本以为这个任务能轻松搞定，结果装了满头的包。

在开启设备定位检测后，使用最大频率采集的数据发现定位一直不太准确，明明我在公司坐着，绘制的定位点一直有偏差，而且每一次采集还会有细微的差别，根据采集的极坐标点绘制的运动轨迹简直没法看，一顿才发现，首先是坐标系统不一致，设备返回的坐标系是地理坐标系统 `WGS84 `,而百度地图默认是投影坐标 `BD09`。常见的三种坐标系统如下

- WGS84 ：地理坐标系统，Google Earth和中国外的Google Map使用，另外，目前基本上所有定位空间位置的设备都使用这种坐标系统，例如手机的GPS系统。
- GCJ-02：投影坐标系统，也就是我们平常所说的火星坐标系，Google Map中国、高德和腾讯好像使用，这个是中国自己在WGS84基础上加密而成，目的显而易见。
- BD09：投影坐标系统，百度地图使用，在GCJ-02基础上二次加密而成。

解决坐标系统不统一的，设备每次返回的坐标点因为不够精准，本来以为是硬件问题，后来发现我们手机定位也是一个概率值，如果发现十次测量中有一次返回的坐标点偏差很大需要将这一点数据去除掉，也就是说拿到运动坐标点集首先需要去噪，需要有一个模糊半径，简单的说就是如果设置模糊半径为10米，设备三次返回的数据都在这个模糊半径范围内，那么我们就认为设备位置没有改变，实际坐标点根据算法取多次测量的中位数，具体实现代码就不放出来了


简单总结一下解决方案
- 地图坐标系统转换（封装了一个js文件搞定）
- 噪点剔除+坐标点集优化
- 设定模糊半径优化设备静止判断

#### 3.硬件对接
印象最深的是当时硬件接口返回参数有两个参数写反了，反馈之后就再没什么消息了，我只好这边委曲求全按照错误的字段对接完成。一个多月过去，突然发现一个神奇的bug，一顿debugger操作发现硬件厂商的开发把这个问题偷偷修复了😂


### 三、后续
#### 1.公司内部晋升成功
还记得当时晋升刚刚遭遇公司内部，需要准备一份PPT，5-6个领导在线欣赏你表演，之后还有答疑环节，我的主要宣讲内容就是物联网这个项目，自我感觉很不错，结果不用说也是顺利通过（后来才知道那次晋升通过率只有40%）。

#### 2.三次技术分享
其中前两次都是项目组内，一次主讲技术，一次主讲业务，有问有答，自我感觉还不错。第三次是领导突然周末联系我让我准备下下班后准备一场分享，只讲技术，说是可能会有几个其他团队的小伙伴来听，来一次vue的入门技术分享就好了。随后建了个群加上我一共是十几个人，大多数使我们们项目组的小伙伴，等到分享开始发现群里已经有了70多人...

<img src="https://i.loli.net/2021/03/17/NwQlBrcd3pgOJof.jpg" alt="图片替换文本" width="300" height="300" align="middle" />

开始有一点紧张，但是开讲技术方案逐渐进入状态，包括之后的答疑环节都算是比较流畅。对了，这是我当时分享出来的[文档](https://stevenlee.blog.csdn.net/article/details/86667313)，当然剔除了业务部分，各位看官尽可放心。


#### 3.CMMI5顺利通过
不了解CMMI的小伙伴可以先通过百度百科给出的解释了解下。
> CMMI 全称是Capability Maturity Model Integration，是能力成熟度集成模型，是由美国国防部与卡内基-梅隆大学和美国国防工业协会共同开发和研制的。CMMI是一套融合多学科的、可扩充的产品集合，其研制的初步动机是为了利用两个或多个单一学科的模型实现一个组织的集成化过程改进。
CMMI分为五个等级，二十五个过程区域（PA），最高为五级。

由于公司招标及业务扩展方面的需求，刚好需要几个的项目去完成CMMI5的`等级认证`，为了这个认证我们项目组我和几位小伙伴专门去上海参加了培训，当时相关的资料也是整理了不少，尤其是我的直属leader出差好几次，好在最终顺利验收通过。

### 三、总结反思
虽说这个项目我已经在一年前就交给其他小伙伴维护了，但现在想起来还是回忆满满，当时满怀激情的与同事探讨解决方案、为解决一个问题冥思苦想、遇到没接触过的问题感觉进行不下去开始怀疑自己等等情景还历历在目，突然觉得应该做个总结了

#### 1.开源方案谨慎选择

选择一个方案不光要关心它的先进性，还要考虑项目实际是否需要、学习成本、社区活跃度、生态完善性等等方案，毕竟这不是你的学习demo。


#### 2.code review 才能进步
哪怕公司项目开发没有`code review`这个环节，也应该自己 review，适当优化。比如说封装、复用性的优化，现在想想当时做的就有所欠缺。

#### 3.统一规范：请使用 eslint + githooks

多人协作开发的项目要想规范统一，首先是要有一份规范吧。其次可以通过eslints保证基本的格式能够统一，要不然默认规则不一致，随手一个格式化然后直接提交真的很要命，至于 `git hooks` 其实就是在 git 提交之间触发 `pre-commit` 钩子，然后可以配合 eslint 检测或是 `commit message` 格式检查，不通过验证不允许提交。

#### 4.结果导向
之前经常遇到一个业务问题，相关开发产品到会议室就开始轮流发表意见，一下午过去头晕脑胀的从会议室出来却发现已经记不清楚太多细节，这时就需要一个人专门记录结果，最终发出来大家也能有一个明确的目标结方案。


谨以此文，聊以慰风尘
